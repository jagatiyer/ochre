{# templates/base.html #}
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Ochre{% endblock %}</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Main stylesheet (versioned) -->
  <link rel="stylesheet" href="{% static 'style.css' %}?v=27">

  {% block extra_head %}{% endblock %}
  <style>
    /* Minimal toast positioning: preserved from your previous file */
    .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        pointer-events: none; /* prevent blocking clicks */
    }
    .toast-msg {
        background: #f5f6f8; /* light background for contrast */
        color: #000; /* dark text for readability */
        padding: 14px 22px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-family: 'Satoshi', sans-serif;
        font-size: 15px;
        border-left: 4px solid #ff5b5f;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        animation: toast-fade 3s forwards;
        min-width: 260px;
        text-align: center;
        pointer-events: auto; /* allow interaction with toasts */
    }
    .toast-msg.success { border-left-color: #00d2c7; }
    .toast-msg.error   { border-left-color: #ff5b5f; }

    @keyframes toast-fade {
        0% { opacity: 1; transform: translateY(0); }
        75% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }

    /* small helper so main page content sits below sticky header */
    main {
      margin-top: 18px; /* extra gap in case header is sticky; adjust if needed */
      min-height: calc(100vh - 150px);
    }
  </style>
</head>

<body>
  {% include "includes/header.html" %}

  <main>
    {% block content %}
    {# pages should supply content here #}
    {% endblock %}
  </main>

  {% include "includes/footer.html" %}

  {# ---------------- Toast messages ---------------- #}
  {% if messages %}
    <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true">
      {% for message in messages %}
        <div class="toast-msg {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {# ---------- JS: dropdown + toast cleanup + extension block ---------- #}
  <script>
  (function () {
    /* USER DROPDOWN TOGGLE (safe: only runs if elements exist) */
    var toggle = document.getElementById('user-toggle');
    var menu = document.getElementById('user-dropdown');
    if (toggle && menu) {
      function openMenu(){
        menu.classList.add('open');
        menu.setAttribute('aria-hidden','false');
        toggle.setAttribute('aria-expanded','true');
      }
      function closeMenu(){
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden','true');
        toggle.setAttribute('aria-expanded','false');
      }
      toggle.addEventListener('click', function (e) {
        e.preventDefault();
        if (menu.classList.contains('open')) closeMenu(); else openMenu();
      });
      document.addEventListener('click', function (e) {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) closeMenu();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeMenu();
      });
    }

    /* REMOVE TOASTS after animation ends (so they don't linger in DOM) */
    var toastContainer = document.getElementById('toast-container');
    if (toastContainer) {
      // remove each toast after its animation finishes (3s as defined)
      setTimeout(function () {
        if (toastContainer && toastContainer.parentNode) {
          toastContainer.parentNode.removeChild(toastContainer);
        }
      }, 3200);
    }
  })();
  </script>
<script>
  (function() {
    const toggle = document.getElementById('user-toggle');
    const dropdown = document.getElementById('user-dropdown');
    const wrapper = document.getElementById('user-dropdown-wrapper');

    if (!toggle || !dropdown) return; // nothing to do

    function openMenu() {
      toggle.setAttribute('aria-expanded', 'true');
      dropdown.setAttribute('aria-hidden', 'false');
      dropdown.focus && dropdown.focus();
    }

    function closeMenu() {
      toggle.setAttribute('aria-expanded', 'false');
      dropdown.setAttribute('aria-hidden', 'true');
    }

    toggle.addEventListener('click', function(e) {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // close on outside click
    document.addEventListener('click', function(e) {
      if (!wrapper.contains(e.target)) {
        closeMenu();
      }
    });

    // close on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.key === 'Esc') {
        closeMenu();
      }
    });

    // keep it keyboard accessible (close on focusout if losing focus completely)
    wrapper.addEventListener('focusout', function(e) {
      // if the new focused element is not inside wrapper, close
      const newFocus = e.relatedTarget;
      if (!wrapper.contains(newFocus)) closeMenu();
    });
  })();
</script>
<script>
  (function(){
    // MEDIA DROPDOWN: click toggle for mobile + keyboard + outside click
    const mToggle = document.getElementById('media-toggle');
    const mMenu = document.getElementById('media-dropdown');
    const mWrapper = document.getElementById('media-dropdown-wrapper');

    if (mToggle && mMenu) {
      function openMenu(){
        mMenu.classList.add('open');
        mMenu.setAttribute('aria-hidden','false');
        mToggle.setAttribute('aria-expanded','true');
      }
      function closeMenu(){
        mMenu.classList.remove('open');
        mMenu.setAttribute('aria-hidden','true');
        mToggle.setAttribute('aria-expanded','false');
      }

      mToggle.addEventListener('click', function(e){
        e.preventDefault();
        const isOpen = mMenu.classList.contains('open') || mMenu.getAttribute('aria-hidden') === 'false';
        if (isOpen) closeMenu(); else openMenu();
      });

      document.addEventListener('click', function(e){
        if (mWrapper && !mWrapper.contains(e.target)) closeMenu();
      });

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeMenu();
      });
    }
  })();
</script>
<script>
  (function(){
    // Mobile off-canvas navigation: open/close, outside tap, ESC, focus trap
    var toggle = document.getElementById('mobile-nav-toggle');
    var menu = document.getElementById('main-menu');
    var overlay = document.getElementById('mobile-nav-overlay');
    var lastFocused = null;

    if (!toggle || !menu || !overlay) return;

    function setAria(open) {
      toggle.setAttribute('aria-expanded', String(open));
      menu.setAttribute('aria-hidden', String(!open));
      overlay.setAttribute('aria-hidden', String(!open));
    }

    function focusableElements(root) {
      return Array.prototype.slice.call(root.querySelectorAll('a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter(function(el){ return !el.hasAttribute('disabled'); });
    }

    function openMenu() {
      lastFocused = document.activeElement;
      menu.classList.add('open');
      overlay.style.display = 'block';
      setAria(true);
      var focusables = focusableElements(menu);
      if (focusables.length) focusables[0].focus();
      // update toggle icon to close (small, non-breaking UI tweak)
      try { toggle.innerHTML = '<i class="fa fa-times" aria-hidden="true"></i>'; } catch(e){}
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menu.classList.remove('open');
      overlay.style.display = 'none';
      setAria(false);
      try { toggle.innerHTML = '<i class="fa fa-bars" aria-hidden="true"></i>'; } catch(e){}
      document.body.style.overflow = '';
      if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
    }

    toggle.addEventListener('click', function(e){
      var isOpen = menu.classList.contains('open');
      if (isOpen) closeMenu(); else openMenu();
    });

    overlay.addEventListener('click', function(e){ closeMenu(); });

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' || e.key === 'Esc') {
        if (menu.classList.contains('open')) closeMenu();
      }

      if (e.key === 'Tab' && menu.classList.contains('open')) {
        var focusables = focusableElements(menu);
        if (!focusables.length) { e.preventDefault(); return; }
        var first = focusables[0], last = focusables[focusables.length-1];
        if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
      }
    });

    // Close on outside click handled by overlay; also ensure clicks outside menu close it
    document.addEventListener('click', function(e){
      if (!menu.contains(e.target) && !toggle.contains(e.target) && menu.classList.contains('open') && !overlay.contains(e.target)) {
        closeMenu();
      }
    });
  })();
</script>
<script>
(function(){
  // helper to update or create cart badge
  function updateCartBadge(count) {
    const cartLink = document.querySelector('.cart-link');
    if (!cartLink) return;
    let badge = cartLink.querySelector('.cart-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'cart-badge';
      cartLink.appendChild(badge);
    }
    badge.textContent = String(count || 0);
    badge.setAttribute('aria-hidden', Number(count) === 0 ? 'true' : 'false');
  }

  // Example: if you use fetch() for add-to-cart, call updateCartBadge with response.cart_count
  // Generic event hook: listen for a custom event so your add-to-cart code can dispatch
  document.addEventListener('ochre:cart-updated', function (ev) {
    if (ev && ev.detail && typeof ev.detail.cart_count !== 'undefined') {
      updateCartBadge(ev.detail.cart_count);
    }
  });

  // Expose helper to global so older inline onclick handlers can call window.updateCartBadge
  window.updateCartBadge = updateCartBadge;

  // Optionally initialize from server-rendered value (if present)
  const serverInit = document.querySelector('.cart-badge');
  if (serverInit) {
    // nothing to do; it's already rendered
  } else {
    // If you want to initialize to 0 on pages with no badge element:
    // updateCartBadge(0);
  }
})();
</script>

  {# -- Feature flags exposed for client-side UI hooks (hidden) -- #}
  <div id="ochre-feature-flags" hidden
       data-google="{% if GOOGLE_OAUTH_AVAILABLE %}1{% else %}0{% endif %}"
       data-razorpay="{% if RAZORPAY_AVAILABLE %}1{% else %}0{% endif %}"
       data-sms="{% if SMS_OTP_AVAILABLE %}1{% else %}0{% endif %}">
  </div>

  {# -- Age verification modal markup (no CSS changes) -- #}

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    (function(){
      // Age gate: show on first visit, store acceptance in localStorage.
      try {
        var key = 'ochre_age_verified_v1';
        if (localStorage && localStorage.getItem && localStorage.getItem(key)) {
          return; // already accepted
        }
      } catch (e) { /* localStorage unavailable; proceed to show gate */ }

      function buildModal() {
        var root = document.getElementById('ochre-age-modal-root');
        if (!root) return null;
        // overlay
        var overlay = document.createElement('div');
        overlay.setAttribute('id','ochre-age-overlay');
        // ensure overlay blocks clicks but doesn't disable pointer behavior for modal children
        overlay.style.pointerEvents = 'auto';

        // modal container - reuse existing site wrapper so styles apply
        var modal = document.createElement('div');
        modal.setAttribute('id','ochre-age-modal');
        modal.className = 'contact-form';
        // ensure modal and children receive pointer events
        modal.style.pointerEvents = 'auto';

        // heading and description
        var h = document.createElement('h2');
        h.textContent = 'Age verification';
        var p = document.createElement('p');
        p.textContent = 'Please select your year of birth to confirm you are 18 or older.';

        // entry choice buttons (Yes / No)
        var entryRow = document.createElement('div');
        entryRow.style.display = 'flex';
        entryRow.style.gap = '12px';
        entryRow.style.marginTop = '12px';

        var yesBtn = document.createElement('button');
        yesBtn.type = 'button';
        yesBtn.textContent = 'Yes, I am 18 or above';
        yesBtn.className = 'cn';
        yesBtn.style.cursor = 'pointer';
        yesBtn.style.pointerEvents = 'auto';

        var noBtn = document.createElement('button');
        noBtn.type = 'button';
        noBtn.textContent = 'No, I am under 18';
        noBtn.className = 'cn stories';
        noBtn.style.cursor = 'pointer';
        noBtn.style.pointerEvents = 'auto';

        entryRow.appendChild(yesBtn);
        entryRow.appendChild(noBtn);

        // groups container (hidden until YES)
        var groupsContainer = document.createElement('div');
        groupsContainer.style.display = 'none';
        groupsContainer.style.marginTop = '14px';
        // center group buttons horizontally
        groupsContainer.style.display = 'none';
        groupsContainer.style.flexWrap = 'wrap';
        groupsContainer.style.justifyContent = 'center';
        groupsContainer.style.alignItems = 'center';

        // years container (hidden until a group chosen)
        var yearsContainer = document.createElement('div');
        yearsContainer.style.display = 'none';
        yearsContainer.setAttribute('aria-hidden','true');

        // underage message (hidden by default)
        var underageMsg = document.createElement('div');
        underageMsg.style.display = 'none';
        var underP = document.createElement('p');
        underP.textContent = 'You must be 18 years or older to enter this site.';
        var leaveBtn = document.createElement('button');
        leaveBtn.type = 'button';
        leaveBtn.textContent = 'Leave site';
        leaveBtn.className = 'cn stories';
        leaveBtn.style.cursor = 'pointer';
        leaveBtn.style.pointerEvents = 'auto';
        underageMsg.appendChild(underP);
        underageMsg.appendChild(leaveBtn);

        // predefined groups
        var groups = [
          {label: '1900 – 1950', start: 1900, end: 1950},
          {label: '1951 – 1975', start: 1951, end: 1975},
          {label: '1976 – 2000', start: 1976, end: 2000},
          {label: '2001 – Present', start: 2001, end: (new Date()).getFullYear()}
        ];

        var groupButtons = [];
        groups.forEach(function(g){
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = g.label;
          btn.className = 'cn';
          btn.setAttribute('data-start', String(g.start));
          btn.setAttribute('data-end', String(g.end));
          // ensure pointer cursor and events for group buttons
          btn.style.cursor = 'pointer';
          btn.style.pointerEvents = 'auto';
          groupButtons.push(btn);
          groupsContainer.appendChild(btn);
        });

        // year grid builder
        function buildYearGrid(start,end){
          var grid = document.createElement('div');
          grid.style.display = 'flex';
          grid.style.flexWrap = 'wrap';
          grid.style.gap = '8px';
          grid.style.marginTop = '12px';
          // center year buttons within the grid
          grid.style.justifyContent = 'center';
          for (var y=end; y>=start; y--) {
            var ybtn = document.createElement('button');
            ybtn.type = 'button';
            ybtn.textContent = String(y);
            ybtn.className = 'cn';
            // ensure pointer cursor and events for year buttons
            ybtn.style.cursor = 'pointer';
            ybtn.style.pointerEvents = 'auto';
            (function(year){
              ybtn.addEventListener('click', function(){
                var currentYear = (new Date()).getFullYear();
                var age = currentYear - year;
                if (age >= 18) {
                  try { localStorage.setItem('ochre_age_verified_v1','1'); } catch(e){}
                  removeModal(modalObj);
                } else {
                  // show underage message
                  groupsContainer.style.display = 'none';
                  yearsContainer.style.display = 'none';
                  underageMsg.style.display = '';
                }
              });
            })(y);
            grid.appendChild(ybtn);
          }
          return grid;
        }

        // wire group button clicks (activate styling and populate years)
        groupButtons.forEach(function(btn){
          btn.addEventListener('click', function(){
            // active state: remove 'shop' class from all, add to clicked
            groupButtons.forEach(function(b){ b.classList.remove('shop'); });
            this.classList.add('shop');
            yearsContainer.innerHTML = '';
            var start = parseInt(this.getAttribute('data-start'),10);
            var end = parseInt(this.getAttribute('data-end'),10);
            yearsContainer.appendChild(buildYearGrid(start,end));
            // show as flex so the grid can be centered
            yearsContainer.style.display = 'flex';
            yearsContainer.style.justifyContent = 'center';
            yearsContainer.style.alignItems = 'center';
            yearsContainer.setAttribute('aria-hidden','false');
          });
        });

        // wire entry buttons
        yesBtn.addEventListener('click', function(){
          entryRow.style.display = 'none';
          underageMsg.style.display = 'none';
          // show groups as centered flex
          groupsContainer.style.display = 'flex';
          // re-enable background page scroll while keeping modal/overlay
          try { document.body.style.overflow = ''; } catch (e) {}
          // focus first group
          if (groupButtons.length && typeof groupButtons[0].focus === 'function') groupButtons[0].focus();
        });
        noBtn.addEventListener('click', function(){
          entryRow.style.display = 'none';
          groupsContainer.style.display = 'none';
          yearsContainer.style.display = 'none';
          underageMsg.style.display = '';
        });
        leaveBtn.addEventListener('click', function(){ window.location.href = 'https://www.google.com'; });

        modal.appendChild(h);
        modal.appendChild(p);
        modal.appendChild(entryRow);
        modal.appendChild(groupsContainer);
        modal.appendChild(yearsContainer);
        modal.appendChild(underageMsg);

        root.appendChild(overlay);
        root.appendChild(modal);

        return {root: root, overlay: overlay, modal: modal, groupsContainer: groupsContainer, yearsContainer: yearsContainer};
      }

      function showModal(m) {
        if (!m) return;
        // prefer CSS-based styling: add an 'open' state so the appended stylesheet can scope styles
        m.overlay.classList.add('ochre-open');
        m.modal.classList.add('ochre-open');

        // focus handling
        m.accept.focus();
      }

      function removeModal(m) {
        if (!m) return;
        if (m.root && m.root.parentNode) {
          m.root.parentNode.removeChild(m.root);
        }
        try { document.body.style.overflow = ''; } catch (e) {}
      }

      var modalObj = buildModal();
      if (!modalObj) return;
      // ensure modal captures pointer events even if root has pointer-events:none
      try { modalObj.modal.style.pointerEvents = 'auto'; modalObj.overlay.style.pointerEvents = 'auto'; } catch (e) {}
      // prevent background scroll while modal open
      try { document.body.style.overflow = 'hidden'; } catch (e) {}
      showModal(modalObj);

      // provide decline path if someone wants to leave immediately (click outside overlay)
      modalObj.overlay.addEventListener('click', function(){
        window.location.href = 'https://www.google.com';
      });

      // prevent tabbing into background content while modal is open
      document.addEventListener('focus', function trapFocus(e){
        if (!modalObj.modal.contains(e.target)) {
          e.stopPropagation();
          // focus first interactive element: first entry button
          var fg = modalObj.modal.querySelector('button');
          if (fg && typeof fg.focus === 'function') fg.focus();
        }
      }, true);
    })();
  });
  </script>

  {% block extra_js %}{% endblock %}

  {# Place modal root at document end so it escapes layout stacking contexts #}
  <div id="ochre-age-modal-root" aria-hidden="true"></div>

</body>
</html>
</html>
