{# templates/base.html #}
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Ochre{% endblock %}</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Main stylesheet (versioned) -->
  <link rel="stylesheet" href="{% static 'style.css' %}?v=27">

  {% block extra_head %}{% endblock %}
  <style>
    /* Minimal toast positioning: preserved from your previous file */
    .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        pointer-events: none; /* prevent blocking clicks */
    }
    .toast-msg {
        background: #f5f6f8; /* light background for contrast */
        color: #000; /* dark text for readability */
        padding: 14px 22px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-family: 'Satoshi', sans-serif;
        font-size: 15px;
        border-left: 4px solid #ff5b5f;
        closeMenu();
          {# -- Feature flags exposed for client-side UI hooks (hidden) -- #}
          <div id="ochre-feature-flags" hidden
               data-google="{% if GOOGLE_OAUTH_AVAILABLE %}1{% else %}0{% endif %}"
               data-razorpay="{% if RAZORPAY_AVAILABLE %}1{% else %}0{% endif %}"
               data-sms="{% if SMS_OTP_AVAILABLE %}1{% else %}0{% endif %}">
          </div>

          {# -- Age verification modal markup (no CSS changes) -- #}
          <div id="ochre-age-modal-root" aria-hidden="true"></div>

          <script>
          (function(){
            // Age gate: show on first visit, store acceptance in localStorage.
            try {
              var key = 'ochre_age_verified_v1';
              if (localStorage && localStorage.getItem && localStorage.getItem(key)) {
                return; // already accepted
              }
            } catch (e) { /* localStorage unavailable; proceed to show gate */ }

            function buildModal() {
              var root = document.getElementById('ochre-age-modal-root');
              if (!root) return null;

              // overlay
              var overlay = document.createElement('div');
              overlay.setAttribute('id','ochre-age-overlay');

              // modal container - reuse existing site wrapper so styles apply
              var modal = document.createElement('div');
              modal.setAttribute('id','ochre-age-modal');
              // reuse site-level form wrapper so site button/form styles apply
              modal.className = 'contact-form';

              // heading
              var h = document.createElement('h2');
              h.textContent = 'Age verification';

              var p = document.createElement('p');
              p.textContent = 'You must be 18 years or older to enter this site. Please confirm.';

              var accept = document.createElement('button');
              accept.type = 'button';
              accept.textContent = 'I am 18+';
              // reuse site button classes used across forms
              accept.className = 'cn';

              var decline = document.createElement('button');
              decline.type = 'button';
              decline.textContent = 'Leave site';
              decline.className = 'cn';

              modal.appendChild(h);
              modal.appendChild(p);
              modal.appendChild(accept);
              modal.appendChild(decline);

              root.appendChild(overlay);
              root.appendChild(modal);

              return {root: root, overlay: overlay, modal: modal, accept: accept, decline: decline};
            }

            function showModal(m) {
              if (!m) return;
              // prefer CSS-based styling: add an 'open' state so the appended stylesheet can scope styles
              m.overlay.classList.add('ochre-open');
              m.modal.classList.add('ochre-open');

              // focus handling
              m.accept.focus();
            }

            function removeModal(m) {
              if (!m) return;
              if (m.root && m.root.parentNode) {
                m.root.parentNode.removeChild(m.root);
              }
            }

            var modal = buildModal();
            if (!modal) return;
            showModal(modal);

            modal.accept.addEventListener('click', function(){
              try { localStorage.setItem('ochre_age_verified_v1', '1'); } catch(e){}
              removeModal(modal);
            });
            modal.decline.addEventListener('click', function(){
              // redirect away; don't attempt to close window programmatically
              window.location.href = 'https://www.google.com';
            });

            // prevent tabbing into background content while modal is open
            document.addEventListener('focus', function trapFocus(e){
              if (!modal.modal.contains(e.target)) {
                e.stopPropagation();
                modal.accept.focus();
              }
            }, true);
          })();
          </script>
      } else {
        openMenu();
      }
    });

    // close on outside click
    document.addEventListener('click', function(e) {
      if (!wrapper.contains(e.target)) {
        closeMenu();
      }
    });

    // close on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.key === 'Esc') {
        closeMenu();
      }
    });

    // keep it keyboard accessible (close on focusout if losing focus completely)
    wrapper.addEventListener('focusout', function(e) {
      // if the new focused element is not inside wrapper, close
      const newFocus = e.relatedTarget;
      if (!wrapper.contains(newFocus)) closeMenu();
    });
  })();
</script>
<script>
  (function(){
    // MEDIA DROPDOWN: click toggle for mobile + keyboard + outside click
    const mToggle = document.getElementById('media-toggle');
    const mMenu = document.getElementById('media-dropdown');
    const mWrapper = document.getElementById('media-dropdown-wrapper');

    if (mToggle && mMenu) {
      function openMenu(){
        mMenu.classList.add('open');
        mMenu.setAttribute('aria-hidden','false');
        mToggle.setAttribute('aria-expanded','true');
      }
      function closeMenu(){
        mMenu.classList.remove('open');
        mMenu.setAttribute('aria-hidden','true');
        mToggle.setAttribute('aria-expanded','false');
      }

      mToggle.addEventListener('click', function(e){
        e.preventDefault();
        const isOpen = mMenu.classList.contains('open') || mMenu.getAttribute('aria-hidden') === 'false';
        if (isOpen) closeMenu(); else openMenu();
      });

      document.addEventListener('click', function(e){
        if (mWrapper && !mWrapper.contains(e.target)) closeMenu();
      });

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeMenu();
      });
    }
  })();
</script>
<script>
  (function(){
    // Mobile off-canvas navigation: open/close, outside tap, ESC, focus trap
    var toggle = document.getElementById('mobile-nav-toggle');
    var menu = document.getElementById('main-menu');
    var overlay = document.getElementById('mobile-nav-overlay');
    var lastFocused = null;

    if (!toggle || !menu || !overlay) return;

    function setAria(open) {
      toggle.setAttribute('aria-expanded', String(open));
      menu.setAttribute('aria-hidden', String(!open));
      overlay.setAttribute('aria-hidden', String(!open));
    }

    function focusableElements(root) {
      return Array.prototype.slice.call(root.querySelectorAll('a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter(function(el){ return !el.hasAttribute('disabled'); });
    }

    function openMenu() {
      lastFocused = document.activeElement;
      menu.classList.add('open');
      overlay.style.display = 'block';
      setAria(true);
      var focusables = focusableElements(menu);
      if (focusables.length) focusables[0].focus();
      // update toggle icon to close (small, non-breaking UI tweak)
      try { toggle.innerHTML = '<i class="fa fa-times" aria-hidden="true"></i>'; } catch(e){}
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menu.classList.remove('open');
      overlay.style.display = 'none';
      setAria(false);
      try { toggle.innerHTML = '<i class="fa fa-bars" aria-hidden="true"></i>'; } catch(e){}
      document.body.style.overflow = '';
      if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
    }

    toggle.addEventListener('click', function(e){
      var isOpen = menu.classList.contains('open');
      if (isOpen) closeMenu(); else openMenu();
    });

    overlay.addEventListener('click', function(e){ closeMenu(); });

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' || e.key === 'Esc') {
        if (menu.classList.contains('open')) closeMenu();
      }

      if (e.key === 'Tab' && menu.classList.contains('open')) {
        var focusables = focusableElements(menu);
        if (!focusables.length) { e.preventDefault(); return; }
        var first = focusables[0], last = focusables[focusables.length-1];
        if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
      }
    });

    // Close on outside click handled by overlay; also ensure clicks outside menu close it
    document.addEventListener('click', function(e){
      if (!menu.contains(e.target) && !toggle.contains(e.target) && menu.classList.contains('open') && !overlay.contains(e.target)) {
        closeMenu();
      }
    });
  })();
</script>
<script>
(function(){
  // helper to update or create cart badge
  function updateCartBadge(count) {
    const cartLink = document.querySelector('.cart-link');
    if (!cartLink) return;
    let badge = cartLink.querySelector('.cart-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'cart-badge';
      cartLink.appendChild(badge);
    }
    badge.textContent = String(count || 0);
    badge.setAttribute('aria-hidden', Number(count) === 0 ? 'true' : 'false');
  }

  // Example: if you use fetch() for add-to-cart, call updateCartBadge with response.cart_count
  // Generic event hook: listen for a custom event so your add-to-cart code can dispatch
  document.addEventListener('ochre:cart-updated', function (ev) {
    if (ev && ev.detail && typeof ev.detail.cart_count !== 'undefined') {
      updateCartBadge(ev.detail.cart_count);
    }
  });

  // Expose helper to global so older inline onclick handlers can call window.updateCartBadge
  window.updateCartBadge = updateCartBadge;

  // Optionally initialize from server-rendered value (if present)
  const serverInit = document.querySelector('.cart-badge');
  if (serverInit) {
    // nothing to do; it's already rendered
  } else {
    // If you want to initialize to 0 on pages with no badge element:
    // updateCartBadge(0);
  }
})();
</script>

  {# -- Feature flags exposed for client-side UI hooks (hidden) -- #}
  <div id="ochre-feature-flags" hidden
       data-google="{% if GOOGLE_OAUTH_AVAILABLE %}1{% else %}0{% endif %}"
       data-razorpay="{% if RAZORPAY_AVAILABLE %}1{% else %}0{% endif %}"
       data-sms="{% if SMS_OTP_AVAILABLE %}1{% else %}0{% endif %}">
  </div>

  {# -- Age verification modal markup (no CSS changes) -- #}
  <div id="ochre-age-modal-root" aria-hidden="true"></div>

  <script>
  (function(){
    // Age gate: show on first visit, store acceptance in localStorage.
    try {
      var key = 'ochre_age_verified_v1';
      if (localStorage && localStorage.getItem && localStorage.getItem(key)) {
        return; // already accepted
      }
    } catch (e) { /* localStorage unavailable; proceed to show gate */ }

    function buildModal() {
      var root = document.getElementById('ochre-age-modal-root');
      if (!root) return null;

      // overlay
      var overlay = document.createElement('div');
      overlay.setAttribute('id','ochre-age-overlay');

      // modal container - reuse existing site wrapper so styles apply
      var modal = document.createElement('div');
      modal.setAttribute('id','ochre-age-modal');
      // reuse site-level form wrapper so site button/form styles apply
      modal.className = 'contact-form';

      // heading
      var h = document.createElement('h2');
      h.textContent = 'Age verification';

      var p = document.createElement('p');
      p.textContent = 'You must be 18 years or older to enter this site. Please confirm.';

      var accept = document.createElement('button');
      accept.type = 'button';
      accept.textContent = 'I am 18+';
      // reuse site button classes used across forms
      accept.className = 'cn';

      var decline = document.createElement('button');
      decline.type = 'button';
      decline.textContent = 'Leave site';
      decline.className = 'cn';

      modal.appendChild(h);
      modal.appendChild(p);
      modal.appendChild(accept);
      modal.appendChild(decline);

      root.appendChild(overlay);
      root.appendChild(modal);

      return {root: root, overlay: overlay, modal: modal, accept: accept, decline: decline};
    }

    function showModal(m) {
      if (!m) return;
      // prefer CSS-based styling: add an 'open' state so the appended stylesheet can scope styles
      m.overlay.classList.add('ochre-open');
      m.modal.classList.add('ochre-open');

      // focus handling
      m.accept.focus();
    }

    function removeModal(m) {
      if (!m) return;
      if (m.root && m.root.parentNode) {
        m.root.parentNode.removeChild(m.root);
      }
    }

    var modal = buildModal();
    if (!modal) return;
    showModal(modal);

    modal.accept.addEventListener('click', function(){
      try { localStorage.setItem('ochre_age_verified_v1', '1'); } catch(e){}
      removeModal(modal);
    });
    modal.decline.addEventListener('click', function(){
      // redirect away; don't attempt to close window programmatically
      window.location.href = 'https://www.google.com';
    });

    // prevent tabbing into background content while modal is open
    document.addEventListener('focus', function trapFocus(e){
      if (!modal.modal.contains(e.target)) {
        e.stopPropagation();
        modal.accept.focus();
      }
    }, true);
  })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
