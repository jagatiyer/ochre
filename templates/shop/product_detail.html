{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/* ================================
   OCHRE PRODUCT DETAIL – UNIT SELECT
   ================================ */

#product-unit-select {
    width: 100%;
    padding: 12px 14px;
    margin: 10px 0 18px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #2a2a2a;
    background-color: #111;
    color: #ffffff;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    cursor: pointer;

    background-image:
        linear-gradient(45deg, transparent 50%, #fff 50%),
        linear-gradient(135deg, #fff 50%, transparent 50%);
    background-position:
        calc(100% - 20px) 50%,
        calc(100% - 14px) 50%;
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
}

#product-unit-select:focus {
    outline: none;
    border-color: #c92a2a; /* Ochre red */
}
</style>
{% endblock %}

{% block content %}
<div class="collection-detail-page">
    <div class="collection-detail-container">

        <!-- LEFT: IMAGE / GALLERY -->
        <div class="collection-detail-image">
            <div class="ochre-product-gallery">

                {% if item.image %}
                    <img
                        id="ochreMainImage"
                        src="{{ item.image.url }}"
                        alt="{{ item.title }}"
                        loading="lazy"
                        style="max-width:100%;height:auto;border-radius:8px;"
                    >
                {% elif item.gallery_images.all %}
                    {% for g in item.gallery_images.all|slice:":1" %}
                        <img
                            id="ochreMainImage"
                            src="{{ g.image.url }}"
                            alt="{{ item.title }}"
                            loading="lazy"
                            style="max-width:100%;height:auto;border-radius:8px;"
                        >
                    {% endfor %}
                {% else %}
                    <img
                        id="ochreMainImage"
                        src="{% static 'img/placeholder.png' %}"
                        alt="{{ item.title }}"
                        loading="lazy"
                        style="max-width:100%;height:auto;border-radius:8px;"
                    >
                {% endif %}

                {% if item.gallery_images.all %}
                <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
                    {% for g in item.gallery_images.all %}
                        <img
                            src="{{ g.image.url }}"
                            alt="{{ item.title }}"
                            style="width:70px;height:70px;object-fit:cover;cursor:pointer;border:1px solid #333;border-radius:6px;"
                            onclick="ochreSwapImage('{{ g.image.url }}')"
                        >
                    {% endfor %}
                </div>
                {% endif %}

            </div>
        </div>

        <!-- RIGHT: DETAILS -->
        <div class="collection-detail-info">

            <div class="collection-detail-category">
                {{ item.category.name }}
            </div>

            <h1 class="collection-detail-title">{{ item.title }}</h1>

            {% if item.caption %}
            <p class="product-caption">{{ item.caption }}</p>
            {% endif %}

            <!-- PRICE -->
            <div style="font-size:22px;color:#00d2c7;margin-bottom:12px;">
                <span id="product-price">
                    {% if item.has_units %}
                        {% with d=item.default_unit %}
                            {% if d %}₹ {{ d.price }}{% else %}{{ item.price_display }}{% endif %}
                        {% endwith %}
                    {% else %}
                        {{ item.price_display }}
                    {% endif %}
                </span>
            </div>

            <!-- ADD TO CART -->
            {% if not item.is_experience %}
            <form method="post" action="{% url 'shop:add_to_cart' %}">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ item.id }}">

                {% if item.has_units %}
                <div class="product-option">
                    <label for="product-unit-select">Size</label>
                    <div class="option-control">
                        <div class="select-wrapper">
                            <select id="product-unit-select" name="product_unit_id" class="select-input">
                                {% for u in item.active_units %}
                                    <option value="{{ u.id }}" data-price="{{ u.price }}" {% if u.is_default %}selected{% endif %}>{{ u.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="product-option">
                    <label for="quantity">Quantity</label>
                    <div class="option-control">
                        <div class="select-wrapper">
                                                        <select id="quantity" name="quantity" class="select-input">
                                                            {% for i in "12345678910"|make_list %}
                                                                <option value="{{ forloop.counter }}" {% if selected_quantity == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                                            {% endfor %}
                                                        </select>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="product-total" style="margin:10px 0;font-size:18px;color:#fff;">
                    <strong>Total: </strong>
                    <span id="total-price">₹ {% with d=item.default_unit %}{% if d %}{{ d.price }}{% else %}{{ item.price_display }}{% endif %}{% endwith %}</span>
                </div>

                                {% if not item.has_units %}
                                <div class="product-option">
                                        <label for="quantity">Quantity</label>
                                        <div class="option-control">
                                                <div class="select-wrapper">
                                                        <select id="quantity" name="quantity" class="select-input">
                                                            {% for i in "12345678910"|make_list %}
                                                                <option value="{{ forloop.counter }}" {% if selected_quantity == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                                            {% endfor %}
                                                        </select>
                                                </div>
                                        </div>
                                </div>
                                {% endif %}

                <button type="submit" class="cn shop">
                    Add to Cart
                </button>
            </form>
            {% else %}
            {# Experience booking UI (UI-only): posts to booking endpoint; backend handles storage. #}
            <form method="post" action="{% url 'shop:experience_booking_create' %}" class="contact-form">
                {% csrf_token %}
                <input type="hidden" name="experience_id" value="{{ item.id }}">

                <div class="form-row">
                    <input id="booking-name" name="customer_name" type="text" placeholder="Full name" required>
                    <input id="booking-email" name="customer_email" type="email" placeholder="Email" required>
                </div>

                <div class="form-row">
                    <input id="booking-phone" name="customer_phone" type="tel" placeholder="Phone (optional)">
                    <input id="booking-date" name="preferred_date" type="text" placeholder="Preferred date (optional)">
                </div>

                <textarea id="booking-notes" name="notes" rows="3" placeholder="Notes (optional)"></textarea>

                <button type="submit" class="cn shop">Request Booking</button>
            </form>
            {% endif %}

            {% if item.description %}
            <div class="product-description">
                {{ item.description|linebreaks }}
            </div>
            {% endif %}

            <a href="{% url 'shop:shop_index' %}" class="back-to-collections">
                ← Back to Shop
            </a>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function ochreSwapImage(url){
    var img = document.getElementById('ochreMainImage');
    if(img){ img.src = url; }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    function updateTotal(){
        var sizeSelect = document.getElementById('product-unit-select');
        var qtySelect = document.getElementById('quantity');
        var totalEl = document.getElementById('total-price');
        if(!totalEl) return;

        var unitPrice = 0;
        if(sizeSelect){
            var opt = sizeSelect.options[sizeSelect.selectedIndex];
            unitPrice = parseFloat(opt && opt.dataset && opt.dataset.price ? opt.dataset.price : 0) || 0;
        } else {
            // fallback: try to read product-price element's data-base-price
            var priceEl = document.querySelector('.product-price');
            unitPrice = priceEl && priceEl.dataset && priceEl.dataset.basePrice ? parseFloat(priceEl.dataset.basePrice) || 0 : 0;
        }

        var qty = qtySelect ? parseInt(qtySelect.value || '1', 10) : 1;
        if(isNaN(qty) || qty < 1) qty = 1;

        var total = unitPrice * qty;
        totalEl.textContent = '₹' + total.toFixed(2);
    }

    document.addEventListener('change', function(e){
        if(e.target && (e.target.id === 'product-unit-select' || e.target.id === 'quantity')){
            updateTotal();
        }
    });

    // initialize on load
    updateTotal();
});
</script>
{% endblock %}
