{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/* Product unit select styling (match site form controls) */
.product-unit-selector, #product-unit-select {
    background: var(--bg-main);
    border: 1px solid #222428;
    color: #ffffff;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 15px;
    width: 100%;
    appearance: none;
}
.product-unit-selector:focus, #product-unit-select:focus {
    border-color: var(--accent-red);
    outline: none;
}

/* Card actions: left = view link, right = add-to-cart */
.collection-card .card-actions{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px;
}
.collection-card .card-actions .left-action { flex:1; }
.collection-card .card-actions .right-action { flex:0 0 auto; }
.collection-card .index-add-btn.cn.shop{ padding:8px 14px; border-radius:8px; }

@media (max-width:720px){
    .collection-card .card-actions{ flex-direction:column; align-items:stretch; }
    .collection-card .card-actions .right-action{ text-align:right; }
}
</style>
{% endblock %}

{% block content %}
<div class="collections-page">

    <div class="collections-header">
        <p class="craft-spirits">
            <span class="dash">—</span>SHOP<span class="dash">—</span>
        </p>

        <h1>Premium Mixers & Accessories</h1>

        <p class="description">
            Elevate your home bar with premium mixers, curated accessories,
            signature merchandise and immersive Ochre experiences.
        </p>
    </div>

        <!-- TAB SELECTOR (centered) -->

    <!-- CATEGORY FILTERS (centered) -->
        <!-- Shop tabs & category filters removed (frozen) -->

    <!-- ITEMS GRID -->
    <div class="products-scroll" style="max-width:1200px; margin: 0 auto; padding: 0 20px;">
        {% if items %}
            {% for item in items %}
            <div class="collection-card">
                {% if item.image and item.image.url %}
                    <img src="{{ item.image.url }}" alt="{{ item.title }}" loading="lazy"
                         style="width:100%; border-radius:8px 8px 0 0; height:auto;">
                {% else %}
                    <div style="height:220px; background:#111; border-radius:8px;"></div>
                {% endif %}

                <p class="collection-card-category">{{ item.category.name }}</p>

                <h3 class="collection-card-title">{{ item.title }}</h3>

                <p class="collection-card-excerpt">
                    {{ item.description|striptags|truncatewords:20 }}
                </p>

                {% if not item.is_experience %}
                    {% if item.has_units %}
                        <p class="product-price" data-product-id="{{ item.id }}" style="color:#fff; font-size:16px; margin-bottom:6px;">
                            ₹ {% with d=item.default_unit %}{% if d %}{{ d.price }}{% else %}{{ item.price }}{% endif %}{% endwith %}
                        </p>
                        <p style="color:#fff; font-size:14px; margin:6px 0 4px;">Unit:</p>
                        <select class="product-unit-selector" data-product-id="{{ item.id }}" style="margin-bottom:8px; width:100%;">
                            {% for u in item.active_units %}
                                <option value="{{ u.id }}" data-price="{{ u.price }}" {% if u.is_default %}selected{% endif %}>{{ u.label }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <p style="color:#fff; font-size:16px; margin-bottom:10px;">
                            {{ item.price_display }}
                        </p>
                    {% endif %}
                {% endif %}

                <div class="card-actions">
                    <div class="left-action">
                        {% if item.is_experience %}
                            <a href="{% url 'shop:product_detail' item.slug %}" class="collection-card-btn">Book Now</a>
                        {% else %}
                            <a href="{% url 'shop:product_detail' item.slug %}" class="collection-card-btn">View Details</a>
                        {% endif %}
                    </div>
                    <div class="right-action">
                        {% if not item.is_experience %}
                        <form method="post" action="{% url 'shop:add_to_cart' %}" class="index-add-form" data-product-id="{{ item.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ item.id }}">
                            <input type="hidden" name="qty" value="1">
                            <input type="hidden" name="product_unit_id" value="{% if item.default_unit %}{{ item.default_unit.id }}{% endif %}">
                            <button type="submit" class="cn shop index-add-btn" {% if item.has_units and not item.default_unit %}disabled{% endif %}>Add to Cart</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="no-products">No items found.</p>
        {% endif %}
    </div>

</div>
{% endblock %}

    {% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.product-unit-selector').forEach(function(sel){
            sel.addEventListener('change', function(){
                var prodId = sel.dataset.productId;
                var opt = sel.options[sel.selectedIndex];
                var priceEl = document.querySelector('.product-price[data-product-id="'+prodId+'"]');
                if(priceEl && opt){
                    var p = opt.dataset.price || '';
                    priceEl.textContent = p ? ('₹ ' + p) : '';
                }
                // sync with index add form for this product
                var form = document.querySelector('.index-add-form[data-product-id="'+prodId+'"]');
                if(form){
                    var hidden = form.querySelector('input[name="product_unit_id"]');
                    if(hidden){ hidden.value = opt ? opt.value : ''; }
                    var btn = form.querySelector('.index-add-btn');
                    if(btn){ btn.disabled = !opt || !opt.value; }
                }
            });
            // trigger change once to initialize state
            sel.dispatchEvent(new Event('change'));
        });
    });
    </script>
    {% endblock %}
