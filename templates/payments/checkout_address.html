{% extends "base.html" %}

{% block content %}
<div class="checkout-address-page">
  <div class="checkout-container">

    <!-- LEFT: Address form -->
    <div class="checkout-form-left">
      <h1>Delivery Address</h1>
      <form method="post" class="contact-form">
        {% csrf_token %}
        {# Render fields using the contact-form conventions (two-column rows where sensible) #}
        <div class="form-row">
          <div>
            <label for="id_full_name">{{ form.full_name.label }}</label>
            {{ form.full_name }}
          </div>
          <div>
            <label for="id_phone">{{ form.phone.label }}</label>
            {{ form.phone }}
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="id_line1">{{ form.line1.label }}</label>
            {{ form.line1 }}
          </div>
          <div>
            <label for="id_line2">{{ form.line2.label }}</label>
            {{ form.line2 }}
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="id_city">{{ form.city.label }}</label>
            {{ form.city }}
          </div>
          <div>
            <label for="id_state">{{ form.state.label }}</label>
            {{ form.state }}
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="id_postcode">{{ form.postcode.label }}</label>
            {{ form.postcode }}
          </div>
          <div>
            <label for="id_country">{{ form.country.label }}</label>
            {{ form.country }}
          </div>
        </div>

        <button type="submit" class="cn shop">Continue</button>
      </form>
    </div>

    <!-- RIGHT: Order summary -->
    <aside class="checkout-order-summary">
      <h2>Order Summary</h2>
      <div class="summary-items">
        <ul id="summary-items-list">
          {% comment %} Populate from session cart via JS for parity without changing payments logic {% endcomment %}
          {% with cart=request.session.cart %}
            {% if cart %}
              {% for item in cart %}
                <li data-price="{{ item.price }}" data-qty="{{ item.qty }}">{{ item.name }} × {{ item.qty }} — ₹{{ item.price|floatformat:-2 }}</li>
              {% endfor %}
            {% else %}
              <li class="no-items">Your cart is empty.</li>
            {% endif %}
          {% endwith %}
        </ul>
      </div>
      <div class="summary-total">Total: <span id="summary-total">—</span></div>
      <a href="{% url 'payments:cart' %}" class="back-to-collections">← Edit cart</a>
    </aside>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Compute and render summary total (prices are stored as paise in session)
  (function(){
    try{
      var total = 0;
      var items = document.querySelectorAll('#summary-items-list li[data-price]');
      items.forEach(function(li){
        var p = parseInt(li.getAttribute('data-price') || '0', 10);
        var q = parseInt(li.getAttribute('data-qty') || '1', 10);
        total += (p * q);
      });
      // convert paise to rupees with two decimals
      var rupees = (total / 100).toFixed(2);
      var el = document.getElementById('summary-total');
      if(el){ el.textContent = '₹' + rupees; }
    }catch(e){ console.warn('Summary total calc failed', e); }
  })();
</script>
{% endblock %}
